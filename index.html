<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéâ Party Galerie</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
/* Header-Inhalt mittig ausrichten */
header { text-align: center; }              /* Text zentrieren */
header .wrap{
  max-width: 1100px;
  margin: 0 auto;                           /* Container zentrieren */
  display: flex;
  flex-direction: column;
  align-items: center;                      /* Inhalt horizontal mittig */
  justify-content: center;                  /* Inhalt vertikal mittig */
}

/* Buttons/Inputs im Header zentrieren (falls noch nicht so) */
.controls{ 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
  justify-content: center; 
}


/* Zustand beim Scrollen: kleiner Header */
header.shrink{
  padding:10px 16px;                 /* weniger H√∂he */
  box-shadow: 0 6px 20px rgba(0,0,0,.35);
  backdrop-filter: blur(2px);
}
header.shrink h1{
  font-size: clamp(16px, 3vw, 22px); /* kleinerer Titel */
}

    .wrap { max-width:1100px; margin:0 auto; padding:0 16px; }
    .controls { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:14px 0; }
    select, input, button { padding:10px 12px; border-radius:8px; border:1px solid #444; background:#333; color:#fff; }
    button { cursor:pointer; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:12px; margin:20px 0 80px; }
    .card { background:#222; border-radius:10px; overflow:hidden; border:1px solid #2a2a2a; }
    .thumb { width:100%; display:block; aspect-ratio:1/1; object-fit:cover; }
    .meta { padding:8px; font-size:12px; display:flex; gap:10px; justify-content:space-between; align-items:center; }
    .left, .right { display:flex; gap:8px; align-items:center; }
    a { color:#4ec9b0; text-decoration:none; }
    .danger { background:#3a1c1c; border-color:#5a2a2a; color:#ffb3b3; border-radius:8px; padding:8px 10px; }
    .note { font-size:12px; opacity:.8; }
    /* Mobile vs. Desktop f√ºr Download */
    .dl { display:none; }
    .mobile-note { display:inline; font-size:12px; opacity:.8; }
    @media (hover:hover) and (pointer:fine) {
      .dl { display:inline-flex; }
      .mobile-note { display:none; }
    }
  </style>
  <script type="module">

    // Header beim Scrollen schrumpfen lassen
    const headerEl = document.querySelector("header");
    const SHRINK_AT = 40; // Pixel, ab wann geschrumpft wird
    
    window.addEventListener("scroll", () => {
      const y = window.scrollY || document.documentElement.scrollTop;
      headerEl.classList.toggle("shrink", y > SHRINK_AT);
    }, { passive: true });
    
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === Deine Supabase-Daten ===
    const SUPABASE_URL  = "https://jwzzlztzvbawxmtwqllf.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3enpsenR6dmJhd3htdHdxbGxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2MjI1ODEsImV4cCI6MjA3NTE5ODU4MX0.Sy7qITsBxTZOogAGgZGlAbnWa5LlTtJppyd_R0Hvv94";
    const BUCKET = "photos";

    // Kategorien (Ordner im Bucket)
    const CATEGORIES = [
      { label: "üì∏ Allgemein", path: "allgemein/" },
      { label: "üßî L√§ngster Bart", path: "laengster-bart/" },
      { label: "üíÉ Beste Tanzmoves", path: "tanzmoves/" },
      { label: "üòÇ Lustigstes Outfit", path: "outfits/" },
      { label: "üçπ Cocktail-Momente", path: "cocktails/" }
    ];

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---- "Eigene Uploads" in localStorage merken ----
    const LS_KEY = "my_uploads_v1"; // Liste aus Pfaden
    function getMyUploads() {
      try { return new Set(JSON.parse(localStorage.getItem(LS_KEY) || "[]")); }
      catch { return new Set(); }
    }
    function addMyUpload(path) {
      const set = getMyUploads(); set.add(path);
      localStorage.setItem(LS_KEY, JSON.stringify([...set]));
    }
    function removeMyUpload(path) {
      const set = getMyUploads(); set.delete(path);
      localStorage.setItem(LS_KEY, JSON.stringify([...set]));
    }
    // --------------------------------------------------

    const sel = () => document.getElementById("category");
    const grid = () => document.getElementById("grid");
    const filesInput = () => document.getElementById("files");
    let currentPrefix = "";

    // Public-URL (Anzeigen)
    function viewUrl(fullPath) {
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(fullPath);
      return data.publicUrl;
    }
    // Download-URL (erzwingt Download in den meisten Browsern)
    function downloadUrl(fullPath) {
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(fullPath, { download: true });
      return data.publicUrl;
    }

    async function listImages(prefix="") {
      currentPrefix = prefix;
      const { data, error } = await supabase
        .storage
        .from(BUCKET)
        .list(prefix, { limit: 1000, sortBy: { column: "created_at", order: "desc" } });

      if (error) { console.error(error); grid().innerHTML = "<p>Fehler beim Laden.</p>"; return; }

      const mine = getMyUploads();
      grid().innerHTML = "";

      for (const f of data) {
        if (f.name.endsWith("/")) continue;
        const fullPath = `${prefix}${f.name}`;
        const vUrl = viewUrl(fullPath);
        const dUrl = downloadUrl(fullPath);
        const isVid = /\.(mp4|webm|mov)$/i.test(f.name);
        const isMine = mine.has(fullPath);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          ${isVid
            ? `<video class="thumb" src="${vUrl}" controls playsinline></video>`
            : `<img class="thumb" src="${vUrl}" alt="${f.name}" loading="lazy" />`
          }
          <div class="meta">
            <div class="left">
              <a class="dl" href="${dUrl}" target="_blank" rel="noopener">‚¨áÔ∏è Download</a>
              <span class="mobile-note">üì± Tippen & halten ‚Üí ‚ÄûIn Fotos sichern‚Äú</span>
            </div>
            <div class="right">
              ${isMine ? `<button class="danger" data-del="${fullPath}">üóëÔ∏è L√∂schen</button>` : ""}
            </div>
          </div>
        `;
        grid().appendChild(card);
      }

      // Event Delegation f√ºr L√∂schen
      grid().onclick = async (e) => {
        const btn = e.target.closest("[data-del]");
        if (!btn) return;
        const path = btn.getAttribute("data-del");
        if (!confirm("Wirklich l√∂schen?")) return;

        const { error } = await supabase.storage.from(BUCKET).remove([path]);
        if (error) { alert("L√∂schen fehlgeschlagen: " + error.message); return; }

        removeMyUpload(path);
        await listImages(currentPrefix);
      };
    }

    async function uploadFiles() {
      const files = filesInput().files;
      if (!files.length) return;
      const cat = sel().value;

      for (const file of files) {
        const safeName = Date.now() + "_" + file.name.replace(/[^a-zA-Z0-9._-]/g,"_");
        const path = `${cat}${safeName}`;
        const { error } = await supabase.storage.from(BUCKET).upload(path, file, { cacheControl:"3600", upsert:false });
        if (error) { alert("Fehler: " + error.message); continue; }
        addMyUpload(path); // merken: dieses Ger√§t hat die Datei hochgeladen
      }
      filesInput().value = "";
      await listImages(cat);
    }

    window.addEventListener("DOMContentLoaded", async () => {
      // Kategorien f√ºllen
      CATEGORIES.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.path;
        opt.textContent = c.label;
        sel().appendChild(opt);
      });

      sel().addEventListener("change", () => listImages(sel().value));
      document.getElementById("uploadBtn").addEventListener("click", uploadFiles);

      await listImages(CATEGORIES[0].path);
    });
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üéâ Party Galerie ‚Äì Lade deine Fotos hoch!</h1>
      <div class="controls">
        <select id="category" title="Kategorie"></select>
        <input type="file" id="files" multiple accept="image/*,video/*" />
        <button id="uploadBtn">Hochladen</button>
      </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid"></div>
  </main>
</body>
</html>



